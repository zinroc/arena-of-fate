module.exports = function (knex) {
    var challengeStore = require("./challengeStore.js")(knex),
        gameStateStore = require("./gameStateStore.js")(knex);


    return {
        /**
        * Advance timestep, meant to be called from server-side only.
        *
        * @param gs     row in game_state table
        * @return Promise, resolving to updated game_state object
        */
        internalAdvanceTimestep: function (gs) {
            return challengeStore.declinePending (gs.timestep)
            .then(function () {
                return challengeStore.declineAccepted (gs.timestep);
            }).then(function (){
                return challengeStore.updateWinningRecords(gs.timestep);
            }).then(function () {
                gs.timestep++;
                return gameStateStore.update(gs);
            }).then(function (rValue) {
                return gameStateStore.read();
            });
        }
    };
};
